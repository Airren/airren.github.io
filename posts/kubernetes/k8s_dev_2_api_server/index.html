<!doctype html><html><head><title>Kubernetes API Basic</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href=/google-fonts/Mulish/mulish.css><link rel=stylesheet href=/fontawesome/css/all.min.css><link rel=icon type=image/png href=/images/site/favicon_hufa9bb061875e5783d83b75135c052e0b_6105_42x0_resize_box_3.png><meta property="og:title" content="Kubernetes API Basic"><meta property="og:description" content="Controller and Operator In this section you&rsquo;ll learn about controllers and operators in Kubernetes and how they work.
The API server has the following core responsibilities:
To serve the Kubernetes API. This API is used cluster-internally by the master components, the worker nodes, and you Kubernetes-native apps, as well as externally by clients such as kubectl. To proxy cluster components, such as the Kubernetes dashboard, or stream logs, services ports, or serve kubectl exec sessions."><meta property="og:type" content="article"><meta property="og:url" content="https://airren.github.io/posts/kubernetes/k8s_dev_2_api_server/"><meta property="article:section" content="posts"><meta name=description content="Kubernetes API Basic"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hue3dcebd3233f4247380b642debb20e00_8242_42x0_resize_box_3.png alt=Logo>
ByteGopher</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/site/main-logo_hue3dcebd3233f4247380b642debb20e00_8242_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu625a7b1b3d293b5088d5bed0b0ae5735_6060_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/blog/ title=Blog>Blog</a></li><li><a href=/posts/cloudnative/ title=CloudNative>CloudNative</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/component/>Infrastructure</a><ul><li><a href=/posts/component/TimeSeries/ title=TimeSeriesDB>TimeSeriesDB</a></li></ul></li><li><a class=active href=/posts/kubernetes/ title=Kubernetes>Kubernetes</a></li><li><a href=/posts/note_c/ title="Note C">Note C</a></li><li><a href=/posts/note_go/ title="Note Go">Note Go</a></li><li><a href=/posts/react/ title=React>React</a></li><li><a href=/posts/sdewan/ title=SDEWAN>SDEWAN</a></li><li><a href=/posts/tips/ title=Tips>Tips</a></li><li><a href=/posts/nodus/ title=Nodus>Nodus</a></li><li><a href=/posts/interview/ title=Interview>Interview</a></li><li><a href=/posts/life/ title=Life>Life</a></li><li><a href=/posts/linux/ title=Linux>Linux</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/airren_hua190a7ea0abcfe5733aac4e715353a6c_101835_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>Airren Ren</h5><p>Monday, January 1, 1</p></div><div class=title><h1>Kubernetes API Basic</h1></div><div class=taxonomy-terms><ul style=padding-left:0></ul></div><div class=post-content id=post-content><h2 id=controller-and-operator>Controller and Operator</h2><p>In this section you&rsquo;ll learn about <code>controllers</code> and <code>operators</code> in Kubernetes and how they work.</p><p>The API server has the following core responsibilities:</p><ul><li>To serve the Kubernetes API. This API is used cluster-internally by the master components, the worker nodes, and you Kubernetes-native apps, as well as externally by clients such as <code>kubectl</code>.</li><li>To proxy cluster components, such as the Kubernetes dashboard, or stream logs, services ports, or serve <code>kubectl exec</code> sessions.</li></ul><p>Per the Kubernetes glossary, a controller implements a control loop, watching the shared state of the cluster throught the API Server and making changes in an attempt to move the current state toward the desired state.</p><p>Befor we dive into the controller&rsquo;s inner working, let&rsquo;s define our terminology:</p><ul><li>Controllers can act on core resources such as deployments or services, which are typically part of Kubernetes controller manager in the control plane, or can watch and manipulate user-defined custome resources.</li><li>Operatirs are controllers that encode some opetational knowledge, such as application lifecycle management, along with the custome resources.</li></ul><h3 id=the-control-loop>The Control Loop</h3><p>In general, the control loop looks as follows:</p><ol><li>Read the state of resources, preferably event-driven.</li><li>Change the state of the objects in the cluster or the cluster-external world. For example, launch a pod, create a network endpoint, or query a cloud API.</li><li>Update status of the resource in step 1 via the API server in etcd.</li><li>Repeat cycle; return to step 1.</li></ol><p>From an architectural point of view, a controller typically uses the following data structures.</p><h4 id=informers>Informers</h4><p>Informers watch the desired state of the resources in a scalable and sustainable fashion. They also implement a resync mechanism that enforces periodic reconciliation, and is often used to make sure that the cluster state and the assumend state cached in memory do not drift (e.g., due bugs or network issues).</p><h2 id=the-api-server>The API Server</h2><p>The API server is the central management entity and <strong>the only component that talks directly with the distributed storage components <code>etcd</code></strong>.</p><p>The API server has the following core responsibilities :</p><ul><li>To server the Kubernets API. This API is used cluster-internally by the master components, the work nodes, and you Kubernetes-native apps, as well as externally by clinets such as <code>kubectl</code>.</li><li>To proxy cluster components, such as the Kubernetes dashboard, or to stream logs, service ports, or serve <code>kubectl exec</code> session.</li></ul><p>Serving the API means:</p><ul><li>Reading state: getting single objects, listing them, and streaming changes</li><li>Manipulating state: creating, updating, and deleting objects</li></ul><p>State is persisted via <code>etcd</code>.</p><h3 id=the-http-interface-of-the-api-server>The HTTP Interface of the API Server</h3><p>From a clinet&rsquo;s perspective, the API service expose a RESTful HTTP API with JSON or protocol buffer(protobuf for short) payload, which is used mainly for cluster-internal communication, for performance reasons.</p><p>The API server HTTP interface handles HTTP requests to query and manipulate Kubernetes resources using the following HTTP verbs(or HTTP methods).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>kubectl -n THENAMESPACE get pods
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>curl -XGET /api/v1/namespaces/THENAMESPACE/pods
</span></span></code></pre></div><h3 id=api-terminology>API Terminology</h3><p>Before we get into the API business, let&rsquo;s first define the terms used in the context of the Kubernetes API server.</p><h4 id=kind>Kind</h4><p>The type of an entity. Each object has a field <code>Kind</code>(lowercase kind in JOSN, capitalized Kind in Golang), which tells a client such as <code>kubectl</code> that it represent, for example, a pod. There are three categories of kinds.</p><ul><li><code>Objects</code> represent <em>a persistent entity in the system</em> &ndash; for example, Pod or Endpoints. Objects have names, and many of the live in namespaces.</li><li><code>Lists</code> are collections of one or more kinds of entities. List have a limit set of common metadata. Examples include PodLists or NodeLists. When you do a <code>kubectl get pods</code>, that&rsquo;s exactly what you get.</li><li><code>Special-purpose kinds</code> are used for specific actions on objects and for nonpersistent entities such as <em><code>/binding</code></em> or <code>/scale</code>. For discovery, Kubernetes use <code>APIGroup</code> and <code>APIResource</code>; for error results, it use <code>Status</code>.</li></ul><p>In Kubernetes programs, <strong>a kind directly corresponds with a Golang type</strong>. Thus, as a Golang type, kinds are singular and begin with a capital letter.</p><h4 id=api-group>API group</h4><p>A collection of Kinds that are logically related. For example, all <strong>batch objects</strong> like <code>Job</code> or <code>ScheduledJob</code> are in the batch API group.</p><h4 id=version>Version</h4><p><strong>Each API group can exist in multiple versions</strong>, and most of them do. For examples, a group first appears as <code>v1alpha1</code> and is then promoted to <code>v1beta1</code> and finally graduates to <code>v1</code>. An object created in one version can be retrieved in each of the supported version. The API server does the lossless conversion to return objects in the requested version. From the cluster user&rsquo;s point of view, versions are just different representations of the same objects.</p><blockquote><p><strong>TIP</strong></p><p>There is no such thing as &ldquo;on object is in v1 in the cluster, and another object is in v1beta1 in the cluster.&rdquo; Instead, every object can be returned as v1 representation or v1alpha1 representation, as the cluster user desires.</p></blockquote><h4 id=resource>Resource</h4><p>A usually lowercase, <strong>plural word</strong>(e.g., pods) identifying as <strong>a set of HTTP endpoints(paths)</strong> exposing the CRUD semantics of a certain object type in the system. Common path are:</p><ul><li>The root, such as .<code>../pods</code>, which list all instances of that type.</li><li>A path for individual named resources, such as <code>..../pods/nginx</code>.</li></ul><p>Typically, each of this endpoints returns and receives one kind(a <code>PodList</code> in the first case, and a <code>Pod</code> in the second). But in other situations, a <code>Status</code> kind object is returned.</p><p>In addition to the main resource with full CRUD semantics, a resource can have further endpoints to perform specific actions(e.g., <code>.../pod/nginx/port-forward</code>, <code>../pod/nginx/exec</code>, or <code>.../pod/nginx/logs</code>). We call these <code>subresources</code>. These usually implement custom protocols instead of REST &ndash; for example, some kind of streaming connections via <strong>WebSocket</strong> or <strong>imperative APIs</strong>.</p><blockquote><p>TIP</p><p>Resources and kinds are often mixed up. Note the clear distinction:</p><ul><li>Resources correspond to HTTP paths</li><li>Kind are the type of objects returned by and received by these endpoints, as well as persisted into etcd.</li></ul></blockquote><p>Resources are always part of an API group and a version, collectively referred to as GroupVersionResource(or GVR). A GVR unique defines an HTTP path.</p><h3 id=kubernets-api-versioning>Kubernets API Versioning</h3><h3 id=declarative-state-management>Declarative State Management</h3><blockquote><p>TIP</p><p>State vs. Status</p><p><strong>State:</strong> the particular condition that someone or something is in at a specific time.</p><p><strong>Status:</strong> the situation at a particular time during a process.</p><p><strong>State</strong> is used to describe a stage in a process (e.g. pending/dispatched).</p><p><strong>Status</strong> is used to describe an outcome of an operation (e.g. success/fail).</p><p><strong>Status</strong> is a final (resulting) State.</p></blockquote><p>Let&rsquo;s talk a little more about spec(desired state) versus status(observed state) in the context of the API server.</p><h2 id=how-the-api-server-processes-the-requests>How the API Server Processes the requests</h2><p>API HTTP handler -> authn & authz -> Mutating adminssion -> Object schema validation -> Validating admission -> Presisting to etcd</p><p>So, what actually happens now when an http requests hits the Kubernetes API? On a high level, the following interactions take place:</p><p>K8s version v1.23.0</p><p>name</p><p>kind</p><p>shortNames</p><p>categories</p><p>resources</p><h4 id=apiv1>api/v1</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>k get --raw /api/v1 | jq -c  <span style=color:#e6db74>&#39;.resources[]|{name,kind,shortNames,categories}&#39;</span>
</span></span></code></pre></div><h4 id=apisbatch>apis/batch</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>k get --raw /apis/batch/v1 | jq -c  <span style=color:#e6db74>&#39;.resources[]|{name,kind,shortNames,categories}&#39;</span>
</span></span></code></pre></div><h4 id=apisappsv1>apis/apps/v1</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>k get --raw /apis/apps/v1 | jq -c  <span style=color:#e6db74>&#39;.resources[]|{name,kind,shortNames,categories}&#39;</span>
</span></span></code></pre></div><h3 id=deepcopy-gen>deepcopy-gen</h3><p>deepcopy-gen 是一个自动生成DeepCopy函数的代码生成器。给定一个包的目录路径作为输入源，它可以为其生成DeepCopy相关函数，这些函数可以有效的执行每种类型的深复制操作。</p><h3 id=groups-and-versions>Groups and Versions</h3><p>An API Group in Kubernetes is simply a collection of related functionality. Each group has one or more versions,</p><h3 id=kinds-and-resources>Kinds and Resources</h3><p>Each API group-version contains one or more API types, which we call Kinds.</p><p>A resource is simply a use of Kind in the API. Often, there&rsquo;s a one-to-one maping between Kinds and resources. For intance, the pods resource crooesponds to the Pod Kind. However, sometimes, the same Kind may be returned by multiple resources. For instances, the Scale Kind is returned by all scale subresources, like deployments/scale or replicatsets/scale. With CRD, however, each Kind will correspond to a single resource.</p><p>When we refer to a kind in a particular group-version, we&rsquo;ll call it a GroupVersionKind, or GVK for short. Same with resources and GVR. As we&rsquo;ll see shortly, each GVK corresponds to a given root Go type in package.</p><h3 id=scheme>Scheme</h3><p>The Scheme is simply a way to keep track of what Go type corresponds to a given GVK.</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/airren/airren.github.io/edit/master/content/posts/kubernetes/k8s_dev_2_api_server.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#controller-and-operator>Controller and Operator</a><ul><li><a href=#the-control-loop>The Control Loop</a><ul><li><a href=#informers>Informers</a></li></ul></li></ul></li><li><a href=#the-api-server>The API Server</a><ul><li><a href=#the-http-interface-of-the-api-server>The HTTP Interface of the API Server</a></li><li><a href=#api-terminology>API Terminology</a><ul><li><a href=#kind>Kind</a></li><li><a href=#api-group>API group</a></li><li><a href=#version>Version</a></li><li><a href=#resource>Resource</a></li></ul></li><li><a href=#kubernets-api-versioning>Kubernets API Versioning</a></li><li><a href=#declarative-state-management>Declarative State Management</a></li></ul></li><li><a href=#how-the-api-server-processes-the-requests>How the API Server Processes the requests</a><ul><li><ul><li><a href=#apiv1>api/v1</a></li><li><a href=#apisbatch>apis/batch</a></li><li><a href=#apisappsv1>apis/apps/v1</a></li></ul></li><li><a href=#deepcopy-gen>deepcopy-gen</a></li><li><a href=#groups-and-versions>Groups and Versions</a></li><li><a href=#kinds-and-resources>Kinds and Resources</a></li><li><a href=#scheme>Scheme</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#achievements>My Story</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:airrenzero#gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>airrenzero#gmail.com</span></a></li><li><span><i class="fas fa-phone-alt"></i></span> <span>+86 1881733xxxx</span></li></ul></div><div class="col-md-4 col-sm-12"><p>Stay up to date with email notification</p><form action="https://github.us1.list-manage.com/subscribe/post?u=19de52a4603135aae97163fd8&amp;amp;id=094a24c76e" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div class=form-group><input type=email class=form-control id=mce-EMAIL name=EMAIL aria-describedby=emailHelp placeholder="Enter email">
<small id=emailHelp class="form-text text-muted">By entering your email address, you agree to receive the newsletter of this website.</small></div><button type=submit class="btn btn-info">Submit</button></form></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2020-2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>