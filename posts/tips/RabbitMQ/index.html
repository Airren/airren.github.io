<!doctype html><html><head><title></title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href=/google-fonts/Mulish/mulish.css><link rel=stylesheet href=/fontawesome/css/all.min.css><link rel=icon type=image/png href=/images/site/favicon_hufa9bb061875e5783d83b75135c052e0b_6105_42x0_resize_box_3.png><meta property="og:title" content><meta property="og:description" content="RabbitMQ 消息中间件 技术精讲
1. RabbitMQ 简介以及AMQP协议 RabbitMQ 是一个开源的消息代理和
RabbitMQ底层是采用Erlang语言进行编写 开源、性能优秀， 稳定性保障 与spring AMQP完美整合，API丰富 集群模式丰富，表达式配置， HA模式， 镜像队列模型 保证数据不丢失的前提做到高可靠性，可用性 AMQP： 高级消息队列协议 RabbitMQ 的安装以及使用 erlang socat rabbitmq-server rpm -ivh XXXXX.rpm lsof -i:5672 # 查看端口 启用控制台插件 rabbit 可以选择使用内存进行存储
RabbitMQ 核心概念 AMQP核心概念
Server：又称作Broker， 接收客户端的连接，实现AMQP实体服务
Connection： 连接， 应用程序与Broker的网络连接
Channel： 网络信道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的一个通道。客户端可以建立多个Channel，每个Channel代表一个会话任务。
Message： 消息， 服务器和应用程序之间传送的数据，由Properties和Body组成。Properties可以对消息进行修饰，比如消息的优先级、延迟等高级特性；Body则就是消息体内容。
Virtual host： 虚拟地址，用于进行逻辑隔离，是最上层的消息路由。一个Virtual Host里面可以有若干个Exchange 和Queue， 同一个Virtual Host里面不能有相同名称的Exchange或Queue。
Exchange： 交换机，接收消息，根据路由键转发消息到绑定的队列
Binding： Exchange 和Queue之间的虚拟连接，binding可以包含routing key
Routing key: 一个路由规则，虚拟机可以用它来确定如何路由一个特定消息
Queue： 也称为Massage Queue, 消息队列，保存消息并将他们转发给消费者
RabbitMQ RabbitMQ默认端口号 4369 (epmd), 25672 (Erlang distribution) 4369 erlang 发现端口 25672 server间通信端口 5672, 5671 (AMQP 0-9-1 without and with TLS) client端通信口 15672 (if management plugin is enabled) 管理界面ui端口 61613, 61614 (if STOMP is enabled) 1883, 8883 (if MQTT is enabled) 生产端的可靠投递 保证消息从生产者到MQ之间的传输是100%可靠的，生产者发送的消息一定能进入消息队列"><meta property="og:type" content="article"><meta property="og:url" content="https://airren.github.io/posts/tips/RabbitMQ/"><meta property="article:section" content="posts"><meta name=description content><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hue3dcebd3233f4247380b642debb20e00_8242_42x0_resize_box_3.png alt=Logo>
ByteGopher</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/site/main-logo_hue3dcebd3233f4247380b642debb20e00_8242_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu625a7b1b3d293b5088d5bed0b0ae5735_6060_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/blog/ title=Blog>Blog</a></li><li><a href=/posts/cloudnative/ title=CloudNative>CloudNative</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/component/>Infrastructure</a><ul><li><a href=/posts/component/TimeSeries/ title=TimeSeriesDB>TimeSeriesDB</a></li></ul></li><li><a href=/posts/kubernetes/ title=Kubernetes>Kubernetes</a></li><li><a href=/posts/note_c/ title="Note C">Note C</a></li><li><a href=/posts/note_go/ title="Note Go">Note Go</a></li><li><a href=/posts/react/ title=React>React</a></li><li><a href=/posts/sdewan/ title=SDEWAN>SDEWAN</a></li><li><a class=active href=/posts/tips/ title=Tips>Tips</a></li><li><a href=/posts/nodus/ title=Nodus>Nodus</a></li><li><a href=/posts/interview/ title=Interview>Interview</a></li><li><a href=/posts/life/ title=Life>Life</a></li><li><a href=/posts/linux/ title=Linux>Linux</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/airren_hua190a7ea0abcfe5733aac4e715353a6c_101835_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>Airren Ren</h5><p>Monday, January 1, 1</p></div><div class=title><h1></h1></div><div class=taxonomy-terms><ul style=padding-left:0></ul></div><div class=post-content id=post-content><h1 id=rabbitmq>RabbitMQ</h1><p>消息中间件 技术精讲</p><h2 id=1-rabbitmq-简介以及amqp协议>1. RabbitMQ 简介以及AMQP协议</h2><p>RabbitMQ 是一个开源的消息代理和</p><ul><li>RabbitMQ底层是采用Erlang语言进行编写</li><li>开源、性能优秀， 稳定性保障</li><li>与spring AMQP完美整合，API丰富</li><li>集群模式丰富，表达式配置， HA模式， 镜像队列模型</li><li>保证数据不丢失的前提做到高可靠性，可用性</li><li>AMQP： 高级消息队列协议<p class=md__image><img src=image-20191011174451555.png alt=image-20191011174451555></p></li></ul><h2 id=rabbitmq-的安装以及使用>RabbitMQ 的安装以及使用</h2><p>erlang
socat
rabbitmq-server
rpm -ivh XXXXX.rpm
lsof -i:5672 # 查看端口
启用控制台插件
rabbit 可以选择使用内存进行存储</p><h2 id=rabbitmq-核心概念>RabbitMQ 核心概念</h2><p><p class=md__image><img src=image-20191011174544262.png alt=image-20191011174544262></p></p><p>AMQP核心概念</p><ul><li><p>Server：又称作Broker， 接收客户端的连接，实现AMQP实体服务</p></li><li><p>Connection： 连接， 应用程序与Broker的网络连接</p></li><li><p>Channel： 网络信道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的一个通道。客户端可以建立多个Channel，每个Channel代表一个会话任务。</p></li><li><p>Message： 消息， 服务器和应用程序之间传送的数据，由Properties和Body组成。Properties可以对消息进行修饰，比如消息的优先级、延迟等高级特性；Body则就是消息体内容。</p></li><li><p>Virtual host： 虚拟地址，用于进行逻辑隔离，是最上层的消息路由。一个Virtual Host里面可以有若干个Exchange 和Queue， 同一个Virtual Host里面不能有相同名称的Exchange或Queue。</p></li><li><p>Exchange： 交换机，接收消息，根据路由键转发消息到绑定的队列</p></li><li><p>Binding： Exchange 和Queue之间的虚拟连接，binding可以包含routing key</p></li><li><p>Routing key: 一个路由规则，虚拟机可以用它来确定如何路由一个特定消息</p></li><li><p>Queue： 也称为Massage Queue, 消息队列，保存消息并将他们转发给消费者</p><img src=img/image-20191011174529046.png alt=image-20191011174529046></li></ul><h2 id=rabbitmq-1>RabbitMQ</h2><h4 id=rabbitmq默认端口号>RabbitMQ默认端口号</h4><ul><li>4369 (epmd), 25672 (Erlang distribution) 4369 erlang 发现端口 25672 server间通信端口</li><li>5672, 5671 (AMQP 0-9-1 without and with TLS) client端通信口</li><li>15672 (if management plugin is enabled) 管理界面ui端口</li><li>61613, 61614 (if STOMP is enabled)</li><li>1883, 8883 (if MQTT is enabled)</li></ul><h4 id=生产端的可靠投递>生产端的可靠投递</h4><p>保证消息从生产者到MQ之间的传输是100%可靠的，生产者发送的消息一定能进入消息队列</p><ul><li>保障消息成功发出， 如果中途由于网络或者其他原因导致发送失败，要保证消息不丢失，可以再次发送。
（如果消息发送成功，但是消费端对消息处理失败，也要考虑消息的重新处理，但不属于此范围）</li><li>保证MQ节点成功接收到消息</li><li>发送端要收到MQ节点(Broker)的确认应答</li><li>完善的消息进行补偿机制？？</li></ul><h6 id=方案1-消息落库对消息状态进行打标>方案1： 消息落库，对消息状态进行打标</h6><p><p class=md__image><img src=image-20191011174752387.png alt=image-20191011174752387></p></p><p>BIZ DB：订单数据库(或其他具体业务) &ndash; 可以说是消息的Payload，具体的消息内容。
MSG DB：消息发送日志数据库 &ndash; 存储消息的发送状态(发送中 0，已确认 1， Retry>max 之后设置为发送失败 2)，重试次数，发送时间等。</p><p>第1步：将订单数据入库，之后创建一条MSG(状态为0) 入MSG DB库
第2步：将消息发送到MQ
第3步：监听消息应答(来自Broker)
第4步：修改消息的状态为1(成功)<font color=red>（只要有应答，MQ一定是收到了消息？消息是否根据exchange和routingKey放入了正确的队列，是否会有异常出现）</font>
第5步：分布式定时任务抓取状态为0的消息
第6步：将状态为0的消息重发
第7步：如果尝试了3次(可按实际情况修改)以上则将状态置为2(消息投递失败状态)</p><p>PS: 这种方案需要<strong>两次入库</strong>，在高并发的场景下性能不是很好。</p><h6 id=方案二-消息延迟投递做二次确认回调检查>方案二： 消息延迟投递，做二次确认，回调检查</h6><p><p class=md__image><img src=watermark.png alt=在这里插入图片描述></p></p><p>Upstream service：上游服务，可能为生产端
Downstream service：下游服务，可能为消费端
MQ Broker：MQ
Callback service：回调服务，监听<code>confirm</code>消息</p><p>第1步：首先业务数据落库，成功才后第一次消息发送
第2步：紧着着发送第2条消息（可以用于寻找第1条消息,消息的ID是唯一的），用于延迟(可能2,3分钟后才发送)消息投递检查
第3步：Broker端收到消息后，消费端进行消息处理
第4步：处理成功后，发送confirm消息（<font color=red>Callback service如何获得confirm信息</font>>）
第5步：收到confirm消息后，将消息进行持久化存储
第6步：收到了delay消息，检查DB数据库，若对应的第1条消息已处理完成，则不做任何事情；若收到了delay消息，检查DB数据库，发现对应的第1条消息处理失败(或无记录)，则发送重传命令到上游服务，循环第1步。</p><hr><p><strong>消息的幂等性</strong></p><p>执行某个操作，无论执行多少次，结果都是一致的就说具有幂等性。</p><p>例如一条更新库存的SQL语句</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>update</span> T_REPS <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>count</span><span style=color:#f92672>=</span><span style=color:#66d9ef>count</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>version</span><span style=color:#f92672>=</span><span style=color:#66d9ef>version</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>version</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>第一步查出记录的version，第二步通过这个version信息进行其他字段的更新。这样无论这条SQL执行 多少次，所得到的的结果都是一致的，就保证了幂等性。</p><p><strong>如何避免重复消费</strong></p><p>消费端实现幂等性，然后永远都不会出现重复消费多次的情况，即使受到多条一样的消息</p><h2 id=消费幂等性>消费幂等性</h2><p>消费端实现幂等性的主流解决方案有以下两种：</p><ul><li><p>唯一ID +指纹码 机制</p></li><li><p>利用Redis的原子性实现</p></li></ul><h4 id=唯一id-指纹码-机制>唯一ID +指纹码 机制</h4><p>利用数据库主键去重
指纹码：可能是业务规则，时间戳+具体银行范围的唯一信息码，能保障这次操作的绝对唯一
比如<code>select count(1) from T_ORDER where id = &lt;唯一ID+指纹码></code>
将唯一ID+指纹码设成主键，如果上面SQL返回1，说明已经操作了，则不需要再次操作；否则才去执行操作
优点： 实现简单
缺点：高并发下有数据库写入的性能瓶颈（解决方案：通过ID进行分库分表进行算法路由）</p><h4 id=利用redis的原子性实现><strong>利用Redis的原子性实现</strong></h4><ul><li>通过setnx等命令</li></ul><p>SET 订单号 时间戳 过期时间</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>SET 1893505609317740 1466849127 EX 300 NX
</span></span></code></pre></div><p>利用Redis进行幂等，需要考虑的问题：</p><p>如果要进行数据落库，关键解决的问题是数据库和缓存如何做到数据一致性。
如果不落库，那么都存在缓存中，如何设置定时同步的策略(同步是指将数据存储到数据库中，不落库指的是暂时不落库，不可能永远不落库)</p><h2 id=投递消息机制>投递消息机制</h2><h4 id=confirm确认消息>Confirm确认消息</h4><ul><li>消息确认，是指生产者消息投递后，如果Broker收到消息，则会给生产者一个应答</li><li>生产者进行接收应答，用来确定这条消息是否正常的发送到Broker，这种方式也是消息的可靠性投递的核心保障</li></ul><p>生产者发送消息与监听Confirm是异步的。(<font color=red>Nack是指接收超时吗?</font>)</p><img src="img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VsdWFuc2hpMTI=,size_16,color_FFFFFF,t_70-20191011203552395.png" alt=在这里插入图片描述 style=zoom:50%><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> TimeoutException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        Connection connection <span style=color:#f92672>=</span> ConnectionUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>getConn</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#75715e>//1. 通过connection创建一个Channel
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#75715e></span>        Channel channel <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span><span style=color:#a6e22e>createChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#75715e>//2.指定消息确认模式
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>confirmSelect</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        String exchangeName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test_confirm_exchange&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        String routingKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;confirm.save&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#75715e>//3. 通过Channel发送数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#75715e></span>        String message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello from Producer&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>basicPublish</span><span style=color:#f92672>(</span>exchangeName<span style=color:#f92672>,</span>routingKey<span style=color:#f92672>,</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#75715e>//4. 添加一个确认监听
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>addConfirmListener</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ConfirmListener<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleAck</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> deliveryTag<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> multiple<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                <span style=color:#75715e>//成功的情况 deliveryTag:消息的唯一标签；
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#75715e></span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;——get ack——&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleNack</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> deliveryTag<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> multiple<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                <span style=color:#75715e>//失败的情况
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#75715e></span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;——have no  ack——&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#75715e>// 关闭掉就没confirm了
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#75715e></span>        <span style=color:#75715e>// CloseTool.closeElegantly(channel,connection);
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        Connection connection <span style=color:#f92672>=</span> ConnectionUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>getConn</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#75715e>//1. 通过connection创建一个Channel
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#75715e></span>        Channel channel <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span><span style=color:#a6e22e>createChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        String exchangeName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test_confirm_exchange&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        String routingKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;confirm.save&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        String queueName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test_confirm_queue&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#75715e>//2. 声明一个exchange
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>exchangeDeclare</span><span style=color:#f92672>(</span>exchangeName<span style=color:#f92672>,</span><span style=color:#e6db74>&#34;topic&#34;</span><span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#75715e>//3. 声明一个队列
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>queueDeclare</span><span style=color:#f92672>(</span>queueName<span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span><span style=color:#66d9ef>false</span><span style=color:#f92672>,</span><span style=color:#66d9ef>false</span><span style=color:#f92672>,</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#75715e>//4. 绑定
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>queueBind</span><span style=color:#f92672>(</span>queueName<span style=color:#f92672>,</span>exchangeName<span style=color:#f92672>,</span>routingKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#75715e>//5. 创建消费者
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#75715e></span>        QueueingConsumer queueingConsumer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueueingConsumer<span style=color:#f92672>(</span>channel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#75715e>//6. 设置Channel
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>basicConsume</span><span style=color:#f92672>(</span>queueName<span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span>queueingConsumer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#75715e>//7. 获取消息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#75715e>//nextDelivery 会阻塞直到有消息过来
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#75715e></span>            QueueingConsumer<span style=color:#f92672>.</span><span style=color:#a6e22e>Delivery</span> delivery <span style=color:#f92672>=</span> queueingConsumer<span style=color:#f92672>.</span><span style=color:#a6e22e>nextDelivery</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            String message <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>(</span>delivery<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;收到:&#34;</span> <span style=color:#f92672>+</span> message<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=return返回消息>return返回消息</h4><ul><li>Return Listener用于处理一些不可路由消息</li><li>生产者指定Exchange和RoutingKey，将消息投递到某个队列，然后消费者监听队列，进行消息处理</li><li>但在某些情况下，在发送消息时，若当前的exchange不存在或指定的路由key路由失败，这时，如果需要监听这种不可达的消息，则要使用return listener</li></ul><p><strong>return 消息机制</strong></p><p>在基础API中有一个关键的配置项：</p><ul><li><p><code>Mandatory</code> : 若为true,则监听器会接收到路由不可达的消息，然后进行后粗处理 ；若为false，则broker端自动删除该消息</p><p>发送端发送了一条消息，但是没有发现Exchange，则可通过return listener监听这些消息</p><img src="img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2VsdWFuc2hpMTI=,size_16,color_FFFFFF,t_70-20191011203510286.png" alt=在这里插入图片描述 style=zoom:50%></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MQ_HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;192.168.222.101&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MQ_VHOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MQ_PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>5672</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> TimeoutException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#75715e>//1. 创建一个ConnectionFactory
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#75715e></span>        ConnectionFactory connectionFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionFactory<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>setHost</span><span style=color:#f92672>(</span>MQ_HOST<span style=color:#f92672>);</span><span style=color:#75715e>//配置host
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#75715e></span>        connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>setPort</span><span style=color:#f92672>(</span>MQ_PORT<span style=color:#f92672>);</span><span style=color:#75715e>//配置port
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#75715e></span>        connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>setVirtualHost</span><span style=color:#f92672>(</span>MQ_VHOST<span style=color:#f92672>);</span><span style=color:#75715e>//配置vHost
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#75715e>//2. 通过连接工厂创建连接
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#75715e></span>        Connection connection <span style=color:#f92672>=</span> connectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>newConnection</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#75715e>//3. 通过connection创建一个Channel
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#75715e></span>        Channel channel <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span><span style=color:#a6e22e>createChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        String exchange <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test_return_exchange&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        String routingKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;return.save&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        String routingKeyError <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abc.save&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#75715e>//4. 通过Channel发送数据
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#75715e></span>        String message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello Return Message&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>addReturnListener</span><span style=color:#f92672>((</span>replyCode<span style=color:#f92672>,</span> replyText<span style=color:#f92672>,</span> exchange1<span style=color:#f92672>,</span> routingKey1<span style=color:#f92672>,</span> properties<span style=color:#f92672>,</span> body<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;——handle return——&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;replyCode:&#34;</span> <span style=color:#f92672>+</span> replyCode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;replyText:&#34;</span> <span style=color:#f92672>+</span> replyText<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;exchange1:&#34;</span> <span style=color:#f92672>+</span> exchange1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;routingKey1:&#34;</span> <span style=color:#f92672>+</span> routingKey1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;properties:&#34;</span> <span style=color:#f92672>+</span> properties<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;body:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>(</span>body<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        <span style=color:#75715e>//mandatory : true
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#75715e></span>        <span style=color:#75715e>//channel.basicPublish(exchange,routingKey,true,null,message.getBytes());
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>basicPublish</span><span style=color:#f92672>(</span>exchange<span style=color:#f92672>,</span>routingKeyError<span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        Connection connection <span style=color:#f92672>=</span> ConnectionUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>getConn</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#75715e>//1. 通过connection创建一个Channel
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#75715e></span>        Channel channel <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span><span style=color:#a6e22e>createChannel</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        String exchange <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test_return_exchange&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        String routingKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;return.#&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        String queueName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test_return_queue&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#75715e>//2. 声明一个exchange
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>exchangeDeclare</span><span style=color:#f92672>(</span>exchange<span style=color:#f92672>,</span><span style=color:#e6db74>&#34;topic&#34;</span><span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span><span style=color:#66d9ef>false</span><span style=color:#f92672>,</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#75715e>//3. 声明一个队列
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>queueDeclare</span><span style=color:#f92672>(</span>queueName<span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span><span style=color:#66d9ef>false</span><span style=color:#f92672>,</span><span style=color:#66d9ef>false</span><span style=color:#f92672>,</span><span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#75715e>//4. 绑定
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>queueBind</span><span style=color:#f92672>(</span>queueName<span style=color:#f92672>,</span>exchange<span style=color:#f92672>,</span>routingKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#75715e>//5. 创建消费者
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#75715e></span>        QueueingConsumer queueingConsumer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueueingConsumer<span style=color:#f92672>(</span>channel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#75715e>//6. 设置Channel
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#75715e></span>        channel<span style=color:#f92672>.</span><span style=color:#a6e22e>basicConsume</span><span style=color:#f92672>(</span>queueName<span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span>queueingConsumer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#75715e>//7. 获取消息
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#75715e>//nextDelivery 会阻塞直到有消息过来
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#75715e></span>            QueueingConsumer<span style=color:#f92672>.</span><span style=color:#a6e22e>Delivery</span> delivery <span style=color:#f92672>=</span> queueingConsumer<span style=color:#f92672>.</span><span style=color:#a6e22e>nextDelivery</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            String message <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>(</span>delivery<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;收到:&#34;</span> <span style=color:#f92672>+</span> message<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当生产端执行<code>channel.basicPublish(exchange,routingKey,true,null,message.getBytes());</code>消息能发送成功，也可以从消费端看到打印</p><p>当执行<code>channel.basicPublish(exchange,routingKeyError,true,null,message.getBytes());</code>消息发送失败，因为路由失败了嘛，生产端能看到如下打印：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>——handle <span style=color:#66d9ef>return</span>——
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>replyCode:312
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>replyText:NO_ROUTE
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>exchange1:test_return_exchange
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>routingKey1:abc.save
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>properties:#contentHeader&lt;basic&gt;<span style=color:#f92672>(</span>content-type<span style=color:#f92672>=</span>null, content-encoding<span style=color:#f92672>=</span>null, headers<span style=color:#f92672>=</span>null, delivery-mode<span style=color:#f92672>=</span>null, priority<span style=color:#f92672>=</span>null, correlation-id<span style=color:#f92672>=</span>null, reply-to<span style=color:#f92672>=</span>null, expiration<span style=color:#f92672>=</span>null, message-id<span style=color:#f92672>=</span>null, timestamp<span style=color:#f92672>=</span>null, type<span style=color:#f92672>=</span>null, user-id<span style=color:#f92672>=</span>null, app-id<span style=color:#f92672>=</span>null, cluster-id<span style=color:#f92672>=</span>null<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>body:Hello Return Message
</span></span></code></pre></div><p><strong>若生产端将mandatory设为false,则ReturnListener不会进行回调</strong></p><h2 id=保障100-的消息可靠性投递方案落地实现>保障100% 的消息可靠性投递方案落地实现</h2></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/airren/airren.github.io/edit/master/content/posts/tips/RabbitMQ.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#1-rabbitmq-简介以及amqp协议>1. RabbitMQ 简介以及AMQP协议</a></li><li><a href=#rabbitmq-的安装以及使用>RabbitMQ 的安装以及使用</a></li><li><a href=#rabbitmq-核心概念>RabbitMQ 核心概念</a></li><li><a href=#rabbitmq-1>RabbitMQ</a><ul><li><ul><li><a href=#rabbitmq默认端口号>RabbitMQ默认端口号</a></li><li><a href=#生产端的可靠投递>生产端的可靠投递</a><ul><li><ul><li><a href=#方案1-消息落库对消息状态进行打标>方案1： 消息落库，对消息状态进行打标</a></li><li><a href=#方案二-消息延迟投递做二次确认回调检查>方案二： 消息延迟投递，做二次确认，回调检查</a></li></ul></li></ul></li></ul></li></ul></li><li><a href=#消费幂等性>消费幂等性</a><ul><li><ul><li><a href=#唯一id-指纹码-机制>唯一ID +指纹码 机制</a></li><li><a href=#利用redis的原子性实现><strong>利用Redis的原子性实现</strong></a></li></ul></li></ul></li><li><a href=#投递消息机制>投递消息机制</a><ul><li><ul><li><a href=#confirm确认消息>Confirm确认消息</a></li><li><a href=#return返回消息>return返回消息</a></li></ul></li></ul></li><li><a href=#保障100-的消息可靠性投递方案落地实现>保障100% 的消息可靠性投递方案落地实现</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=https://airren.github.io/#achievements>My Story</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:airrenzero#gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>airrenzero#gmail.com</span></a></li><li><span><i class="fas fa-phone-alt"></i></span> <span>+86 1881733xxxx</span></li></ul></div><div class="col-md-4 col-sm-12"><p>Stay up to date with email notification</p><form action="https://github.us1.list-manage.com/subscribe/post?u=19de52a4603135aae97163fd8&amp;amp;id=094a24c76e" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div class=form-group><input type=email class=form-control id=mce-EMAIL name=EMAIL aria-describedby=emailHelp placeholder="Enter email">
<small id=emailHelp class="form-text text-muted">By entering your email address, you agree to receive the newsletter of this website.</small></div><button type=submit class="btn btn-info">Submit</button></form></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2020-2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>